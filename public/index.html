<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diet Planner</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="frontend-integration.js"></script>

  <style>
    /* Logo + title alignment */
    .logo-title { display: flex; align-items: center; gap: 12px; }
    .logo-title h1 { margin: 0; line-height: 1; }
    #customized-title {
      color: red;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px;
    }

    .left,
    .middle,
    .right {
      flex: 1;
      min-width: 280px;
    }

    iframe {
      width: 100%;
      height: 200px;
      border: none;
      margin-bottom: 10px;
    }

    /* Enhanced greeting styles */
    #greeting {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #2e7d32;
      transition: all 0.3s ease;
    }

    .greeting-logged-in {
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9) !important;
      padding: 15px !important;
      border-radius: 10px !important;
      border: 2px solid #c8e6c9 !important;
      box-shadow: 0 4px 8px rgba(76, 175, 80, 0.1) !important;
      animation: welcomeGlow 2s ease-in-out;
    }

    @keyframes welcomeGlow {
      0% { box-shadow: 0 4px 8px rgba(76, 175, 80, 0.1); }
      50% { box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3); }
      100% { box-shadow: 0 4px 8px rgba(76, 175, 80, 0.1); }
    }

    .welcome-message {
      font-size: 14px;
      font-weight: normal;
      margin-top: 5px;
      color: #666;
    }

    /* Navigation user section */
    .nav-user-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-name {
      color: white;
      font-weight: 500;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: #c0392b;
    }
    .review-section {
      margin: 40px 20px;
      padding: 30px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .review-section h2 {
      text-align: center;
      color: #2e7d32;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .add-review-btn {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .add-review-btn:hover {
      background: linear-gradient(135deg, #45a049, #388e3c);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
    }

    .reviews-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .review-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border-left: 4px solid #4caf50;
      position: relative;
    }

    .review-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .review-header-info {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      gap: 15px;
    }

    .reviewer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4caf50, #45a049);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      flex-shrink: 0;
    }

    .reviewer-info {
      flex-grow: 1;
    }

    .reviewer-info h4 {
      margin: 0;
      color: #2e7d32;
      font-size: 18px;
    }

    .reviewer-info .review-date {
      color: #666;
      font-size: 12px;
      margin-top: 2px;
    }

    .stars {
      font-size: 18px;
      margin: 10px 0;
      color: #ffc107;
    }

    .review-text {
      color: #444;
      line-height: 1.6;
      margin-top: 10px;
    }

    /* Delete button styles */
    .delete-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
    }

    .review-card:hover .delete-btn {
      opacity: 1;
      transform: scale(1);
    }

    .delete-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    .delete-btn:active {
      transform: scale(0.95);
    }

    /* Review ownership indicator */
    .review-card.own-review {
      border-left-color: #ffc107;
      background: linear-gradient(135deg, #fffbf0, #ffffff);
    }

    .review-card.own-review .reviewer-avatar {
      background: linear-gradient(135deg, #ffc107, #ffb300);
    }

    .own-review-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #ffc107;
      color: #333;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    /* Review Form Modal */
    .review-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .review-modal.show {
      display: flex;
    }

    .review-form-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .review-form h3 {
      text-align: center;
      color: #2e7d32;
      margin-bottom: 25px;
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4caf50;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Star Rating Input */
    .star-rating {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      font-size: 24px;
      color: #ddd;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input:checked ~ label {
      color: #ffc107;
    }

    .star-rating input:checked + label,
    .star-rating input:checked + label ~ label {
      color: #ffc107;
    }

    .form-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .btn-submit {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background: linear-gradient(135deg, #45a049, #388e3c);
      transform: translateY(-2px);
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .btn-cancel:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .no-reviews {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
      background: white;
      border-radius: 10px;
      margin: 20px 0;
    }

    /* Confirmation modal */
    .confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .confirm-modal.show {
      display: flex;
    }

    .confirm-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .confirm-content h3 {
      color: #dc3545;
      margin-bottom: 15px;
    }

    .confirm-content p {
      margin-bottom: 25px;
      color: #666;
    }

    .confirm-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .btn-confirm-delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .btn-confirm-delete:hover {
      background: #c82333;
    }

    .btn-confirm-cancel {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn-confirm-cancel:hover {
      background: #5a6268;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .review-header {
        flex-direction: column;
        text-align: center;
      }

      .reviews-container {
        grid-template-columns: 1fr;
      }

      .review-form-container {
        margin: 20px;
        width: calc(100% - 40px);
      }

      .delete-btn {
        opacity: 1;
        transform: scale(1);
      }
    }
      /* Details card */
      .input-section {
        max-width: 420px;
        margin: 30px auto;
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .input-section h2 {
        text-align: center;
        margin: 0 0 10px;
        color: #2e7d32;
      }
      .input-section label { font-weight: 600; margin-top: 6px; color: #333; }
      .input-section input {
        width: 100%;
        padding: 10px;
        border: 1.5px solid #e0e0e0;
        border-radius: 8px;
        box-sizing: border-box;
      }
      .input-section .btn { margin-top: 8px; }
  </style>
</head>

<body>
  <header>
    <div class="logo-title">
      <img src="image/logo.svg" alt="Diet Planner Logo" width="48" height="48" loading="lazy">
      <h1>Diet Planner</h1>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="summary.html">Summary</a></li>
            <li><a href="healthtracker.html">Health Tracker</a></li>
        <li><a href="chatbot.html">Chat Bot</a></li>
        <li id="authSection">
          <a href="login.html">Login</a>
        </li>
      </ul>
    </nav>
  </header>

  <div class="middle">
    <!-- Enhanced Personalized Greeting -->
    <div id="greeting">Good Night</div>

    <div class="quote-section">
      <!--<img src="https://via.placeholder.com/400x150" alt="Motivation">-->
      <blockquote>"Your body is your temple, take care of it."</blockquote>
    </div>

    <div class="diet-options">
      <!-- Diet Options -->
      <label class="diet-option">
        <input type="radio" name="diet" value="Keto">
        <img src="image/keto.jpg" alt="Keto Diet" class="diet-img">
        <span>Keto</span>
        <button class="know-more">Know More</button>
        <div class="diet-info">
          <p>The Keto diet is a low-carb, high-fat diet that helps in burning fat efficiently.</p>
        </div>
      </label>

      <label class="diet-option">
        <input type="radio" name="diet" value="Gluten-Free">
        <img src="image/glutenfree.jpg" alt="Gluten-Free Diet" class="diet-img">
        <span>Gluten-Free</span>
        <button class="know-more">Know More</button>
        <div class="diet-info">
          <p>The Gluten-Free diet is suitable for people with gluten intolerance or celiac disease.</p>
        </div>
      </label>

      <label class="diet-option">
        <input type="radio" name="diet" value="Veg">
        <img src="image/veg.jpg" alt="Vegetarian Diet" class="diet-img">
        <span>Vegetarian</span>
        <button class="know-more">Know More</button>
        <div class="diet-info">
          <p>The Vegetarian diet avoids meat, poultry, and fish, focusing on vegetables, fruits,
            grains, legumes, and dairy.</p>
        </div>
      </label>

      <label class="diet-option">
        <input type="radio" name="diet" value="Vegan">
        <img src="image/vegan.jpg" alt="Vegan Diet" class="diet-img">
        <span>Vegan</span>
        <button class="know-more">Know More</button>
        <div class="diet-info">
          <p>The Vegan diet excludes all animal products and focuses on plant-based foods.</p>
        </div>
      </label>

      <label class="diet-option">
        <input type="radio" name="diet" value="Non-Veg">
        <img src="image/nonveg.jpg" alt="Non-Veg Diet" class="diet-img">
        <span>Non-Veg</span>
        <button class="know-more">Know More</button>
        <div class="diet-info">
          <p>The Non-Veg diet includes meat, poultry, fish, and other animal-based products.</p>
        </div>
      </label>
    </div>

    <div class="input-section">
      <h2>Enter Your Details</h2>
      <label for="height">Height (cm)</label>
      <input type="number" id="height" placeholder="e.g., 170" oninput="updateLiveBMI()">

      <label for="weight">Current Weight (kg)</label>
      <input type="number" id="weight" placeholder="e.g., 70" oninput="updateLiveBMI()">

      <label for="goal">Goal Weight (kg)</label>
      <input type="number" id="goal" placeholder="e.g., 65">

      <label for="bmiDisplay">BMI</label>
      <input type="text" id="bmiDisplay" placeholder="BMI will appear here" readonly>

      <button class="btn" onclick="calculateBMI()">Calculate BMI & Show Summary</button>
    </div>

    <!-- New Summary Section (moved before videos) -->
    <div id="userSummary" style="margin-top:20px; display:none;">
      <p><strong>BMI:</strong> <span id="bmiVal"></span></p>
      <p><strong>Goal Weight (kg):</strong> <span id="goalVal"></span></p>
      <p><strong>Diet Type:</strong> <span id="dietVal"></span></p>
      <p><strong>Calorie Limit:</strong> <span id="calorieVal"></span> kcal/day</p>
      <button class="btn" onclick="saveAndRedirect()">Generate Plan</button>
    </div>
  </div>

  <div class="right">
    <h2>Diet Tips</h2>
    <iframe src="https://www.youtube.com/watch?v=q42n27oCOUM" title="Diet Tips"></iframe>
    <h2>Exercise Videos</h2>
    <iframe src="https://www.youtube.com/embed/UItWltVZZmE" title="Exercise"></iframe>
    <h2>Healthy Recipes</h2>
    <iframe src="https://www.youtube.com/embed/4zG4TG6AQa0" title="Recipes"></iframe>
  </div>
   <!-- <section id="ai-plan-section">
  <h2>🔮 Personalized Meal Suggestions</h2>
  <form id="aiPlanForm">
    <label for="goals">Your Goals & Restrictions:</label>
    <textarea id="goals" required placeholder="e.g. 1500 kcal/day, vegetarian, gluten–free"></textarea>
    <button type="submit">Generate Meal Plan</button>
  </form>
  <pre id="aiPlanOutput"></pre>
</section>-->
  <section class="review-section">
    <h2>Success Stories & Reviews</h2>
    <!-- Reviews (kept same) -->
    <div class="review-card">
      <div>
        <p><strong>Alex</strong> – "I lost 10kg in 3 months with this plan!"</p>
        <p class="long-story">I always struggled to stick to a diet. This app provided a
          personalized plan that was easy to follow and had healthy recipes. Today, I feel more
          confident than ever!</p>
        <div class="stars">⭐⭐⭐⭐⭐</div>
      </div>
    </div>
  </section>
   
  <footer>
    <p>Follow us:
      <a href="#">Facebook</a> |
      <a href="#">Instagram</a> |
      <a href="#">Twitter</a>
    </p>
    <p>Contact: dietplanner@example.com</p>
  </footer>

  <script>
    // Enhanced Personalized Greeting Function
    displayPersonalizedGreeting();
      
      // Optionally redirect to home
      window.location.reload();
    

    // BMI Calculation function (cleaned up)

   /*
      const height = parseFloat(document.getElementById("height").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const goal = parseFloat(document.getElementById("goal").value);
      const diet = document.querySelector('input[name="diet"]:checked')?.value;

      if (!height || !weight || !goal || !diet) {
        alert("Please fill all fields and select a diet.");
        return;
      }

      // BMI calculation
      const heightInM = height / 100; // Convert cm to meters
      const bmi = (weight / (heightInM * heightInM)).toFixed(1);

        const bmiDisplay = document.getElementById('bmiDisplay');
        if (bmiDisplay) bmiDisplay.value = bmi;

      // Calorie limit logic
      let calorieLimit;
      if (bmi < 18.5) calorieLimit = 2200;
      else if (bmi < 24.9) calorieLimit = 1800;
      else if (bmi < 29.9) calorieLimit = 1600;
      else calorieLimit = 1500;

      if (diet === "Keto") calorieLimit += 100;
      if (diet === "Vegan") calorieLimit -= 50;

      // Display summary
      document.getElementById("userSummary").style.display = "block";
      document.getElementById("bmiVal").innerText = bmi;
      document.getElementById("goalVal").innerText = goal;
      document.getElementById("dietVal").innerText = diet;
      document.getElementById("calorieVal").innerText = calorieLimit;

      // Save to user-scoped localStorage
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      const id = user?.id || user?.email || 'guest';
      const key = k => `${k}:${id}`;
      localStorage.setItem(key("bmi"), bmi);
      localStorage.setItem(key("goal"), goal);
      localStorage.setItem(key("diet"), diet);
      localStorage.setItem(key("calorieLimit"), calorieLimit);
      localStorage.setItem(key("weight"), weight);
      localStorage.setItem(key("heightCm"), height);
      // Also keep global keys for backward compatibility
      localStorage.setItem("bmi", bmi);
      localStorage.setItem("goal", goal);
      localStorage.setItem("diet", diet);
      localStorage.setItem("calorieLimit", calorieLimit);
      localStorage.setItem("weight", weight);
      // Save to backend if logged in so Summary/Health Tracker reflect next login
      try {
        const token = localStorage.getItem('authToken');
        const userObj = JSON.parse(localStorage.getItem('user') || 'null');
        if (token) {
          console.log('Sending to backend with token:', { dietType: diet, height, weight, goalWeight: goal, calorieTarget: calorieLimit, bmi });
          fetch('http://localhost:3000/api/diet-preferences', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({
              dietType: diet,
              height: height,
              weight: weight,
              goalWeight: goal,
              activityLevel: 'moderate',
              calorieTarget: calorieLimit,
              bmi: parseFloat(bmi)
            })
          }).then(res => {
            console.log('Backend save response:', res.status);
            return res.json();
          }).then(data => {
            console.log('Backend save success:', data);
          }).catch(err => {
            console.error('Backend save error:', err);
          });
        } else if (userObj?.email) {
          // Public fallback if token missing: save by email
          fetch('http://localhost:3000/api/diet-preferences/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: userObj.email,
              dietType: diet,
              height: height,
              weight: weight,
              goalWeight: goal,
              activityLevel: 'moderate',
              calorieTarget: calorieLimit,
              bmi: bmi
            })
          }).then(res => {
            console.log('Public backend save response:', res.status);
            return res.json();
          }).then(data => {
            console.log('Public backend save data:', data);
          }).catch(err => {
            console.error('Public backend save error:', err);
          });
        }
      } catch (e) { 
        console.error('Backend save exception:', e);
      }
    } */

  async function calculateBMI() {
  const height = parseFloat(document.getElementById("height").value);
  const weight = parseFloat(document.getElementById("weight").value);
  const goal = parseFloat(document.getElementById("goal").value);
  const diet = document.querySelector('input[name="diet"]:checked')?.value;

  if (!height || !weight || !goal || !diet) {
    alert("Please fill all fields and select a diet.");
    return;
  }

  // BMI calculation
  const heightInM = height / 100;
  const bmi = (weight / (heightInM * heightInM)).toFixed(1);

  // Calorie calculation
  let calorieLimit;
  if (bmi < 18.5) calorieLimit = 2200;
  else if (bmi < 24.9) calorieLimit = 1800;
  else if (bmi < 29.9) calorieLimit = 1600;
  else calorieLimit = 1500;

  if (diet === "Keto") calorieLimit += 100;
  if (diet === "Vegan") calorieLimit -= 50;

  // Display summary
  document.getElementById("userSummary").style.display = "block";
  document.getElementById("bmiVal").innerText = bmi;
  document.getElementById("goalVal").innerText = goal;
  document.getElementById("dietVal").innerText = diet;
  document.getElementById("calorieVal").innerText = calorieLimit;

  // Save to localStorage (backup)
  const summaryData = {
    bmi: bmi,
    height: height,
    weight: weight,
    goalWeight: goal,
    dietType: diet,
    calorieLimit: calorieLimit
  };
  
  localStorage.setItem("userSummary", JSON.stringify(summaryData));
  localStorage.setItem("bmi", bmi);
  localStorage.setItem("goal", goal);
  localStorage.setItem("diet", diet);
  localStorage.setItem("calorieLimit", calorieLimit);
  localStorage.setItem("height", height);
  localStorage.setItem("weight", weight);

  // Save to backend if logged in
  await saveSummaryToBackend(summaryData);
}

// Add this new function
async function saveSummaryToBackend(summaryData) {
  const authToken = localStorage.getItem('authToken');
  
  if (!authToken) {
    console.log('User not logged in, data saved to localStorage only');
    return;
  }

  try {
    const response = await fetch('/api/update-diet-preferences', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(summaryData)
    });

    if (response.ok) {
      const result = await response.json();
      console.log('Summary saved to backend successfully:', result);
    } else {
      console.error('Failed to save summary to backend');
    }
  } catch (error) {
    console.error('Error saving summary to backend:', error);
  }
}



    function updateLiveBMI() {
      const height = parseFloat(document.getElementById("height").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const bmiDisplay = document.getElementById('bmiDisplay');
      if (!height || !weight || !bmiDisplay) return;
      const heightInM = height / 100;
      const bmi = (weight / (heightInM * heightInM)).toFixed(1);
      if (isFinite(bmi)) bmiDisplay.value = bmi;
    }

    function saveAndRedirect() {
      window.location.href = "summary.html";
    }

    // Initialize greeting when page loads
    document.addEventListener('DOMContentLoaded', function() {
      displayPersonalizedGreeting();
      
      // Update greeting every minute
      setInterval(displayPersonalizedGreeting, 60000);
    });

    // Listen for storage changes (when user logs in/out in another tab)
    window.addEventListener('storage', function(e) {
      if (e.key === 'authToken' || e.key === 'user') {
        displayPersonalizedGreeting();
      }
    });

    // Update greeting after login (call this from login success)
    function updateGreetingOnAuth() {
      setTimeout(displayPersonalizedGreeting, 100);
    }

    // Update auth section in navigation
    function updateAuthSection(isLoggedIn) {
      const authSection = document.getElementById('authSection');
      
      if (isLoggedIn) {
        const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
        const firstName = userInfo.name ? userInfo.name.split(' ')[0] : 'User';
        
        authSection.innerHTML = `
          <div class="nav-user-section">
           // <span class="user-name">Hi, ${firstName}</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
          </div>
        `;
      } else {
        authSection.innerHTML = '<a href="login.html">Login</a>';
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      localStorage.removeItem('diet');
      localStorage.removeItem('bmi');
      localStorage.removeItem('goal');
      localStorage.removeItem('calorieLimit');
      
      // Show logout confirmation
      alert('You have been logged out successfully!');
      
      // Update greeting and navigation
      displayPersonalizedGreeting();
      
      // Optionally redirect to home
      window.location.reload();
    }
    //imp
async function saveSummaryToBackend(summaryData) {
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  if (!user.id) {
    console.log("User not logged in");
    return;
  }
  

  // Force correct types
  const payload = {
    userId: user.id,
    dietType: summaryData.dietType,
    height: Number(summaryData.height) || 0,
    weight: Number(summaryData.weight) || 0,
    goalWeight: Number(summaryData.goalWeight) || 0,
    activityLevel: 'moderate',
    calorieTarget: Number(summaryData.calorieLimit),
    bmi: Number(summaryData.bmi) || 0
  };

  console.log("Sending payload:", payload);

  try {
    const response = await fetch('/api/diet-preferences', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    console.log("Backend response:", result);
  } catch (err) {
    console.error("Error saving to backend:", err);
  }
}


    // BMI Calculation function (cleaned up)
    function calculateBMI() {
      const height = parseFloat(document.getElementById("height").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const goal = parseFloat(document.getElementById("goal").value);
      const diet = document.querySelector('input[name="diet"]:checked')?.value;

      if (!height || !weight || !goal || !diet) {
        alert("Please fill all fields and select a diet.");
        return;
      }

      // BMI calculation
      const heightInM = height / 100; // Convert cm to meters
      const bmi = (weight / (heightInM * heightInM)).toFixed(1);

      // Calorie limit logic
      let calorieLimit;
      if (bmi < 18.5) calorieLimit = 2200;
      else if (bmi < 24.9) calorieLimit = 1800;
      else if (bmi < 29.9) calorieLimit = 1600;
      else calorieLimit = 1500;

      if (diet === "Keto") calorieLimit += 100;
      if (diet === "Vegan") calorieLimit -= 50;

      // Display summary
      document.getElementById("userSummary").style.display = "block";
      document.getElementById("bmiVal").innerText = bmi;
      document.getElementById("goalVal").innerText = goal;
      document.getElementById("dietVal").innerText = diet;
      document.getElementById("calorieVal").innerText = calorieLimit;

      // Save to localStorage
      localStorage.setItem("bmi", bmi);
      localStorage.setItem("goal", goal);
      localStorage.setItem("diet", diet);
      localStorage.setItem("calorieLimit", calorieLimit);
    }

    function saveAndRedirect() {
      window.location.href = "summary.html";
    }

    // Initialize greeting when page loads
    document.addEventListener('DOMContentLoaded', function() {
      displayPersonalizedGreeting();
      
      // Update greeting every minute
      setInterval(displayPersonalizedGreeting, 60000);
    });

    // Listen for storage changes (when user logs in/out in another tab)
    window.addEventListener('storage', function(e) {
      if (e.key === 'authToken' || e.key === 'user') {
        displayPersonalizedGreeting();
      }
    });

    // Update greeting after login (call this from login success)
    function updateGreetingOnAuth() {
      setTimeout(displayPersonalizedGreeting, 100);
    }

   
  </script>
  <script src="script.js"></script>
  

</body>

</html>